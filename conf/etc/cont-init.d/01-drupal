#!/usr/bin/with-contenv sh

run(){
    eval "su - nginx -s /bin/ash -c 'cd /var/www/drupal/ && "$@"'" 
    return $? 
}

install(){
    echo "> Install"
    if [ ! -d /var/www/drupal ] 
    then
        echo ">>> No volume mounted"
        echo ">>>>> Create working dir"
        mkdir -p /var/www/drupal
        chown nginx:nginx /var/www/drupal
    fi
    INSTALLED=$(run vendor/bin/drush status)
    if [ -z "$INSTALLED" ];
    then
        echo ">>> Installing"
        mv -u /opt/ressources/drupal/* /opt/ressources/drupal/.*  /var/www/drupal/ 2>/dev/null
        echo ">>> Fixing permissions"
        chown nginx:nginx /var/www/drupal -R
    else
        echo ">>> Already Installed"
    fi

    return 0
}



config(){

    echo "> Config"
    echo ">>> Waiting for database to be ready"
    while  ! $( nc -vz ${DATABASE_HOST} ${DATABASE_PORT} ) ;
    do
            sleep 1
    done
    CONFIG=$(run vendor/bin/drush status bootstrap | grep Successful)
    if [ -z "$CONFIG" ];
    then 
        echo ">>> Configuring"
        echo y | run $( echo 'vendor/bin/drush site-install --db-url="mysql://'${DRUPAL_DB_USERNAME}':'${DRUPAL_DB_PASSWORD}'@'${DATABASE_HOST}':'${DATABASE_PORT}'/'${DRUPAL_DB_NAME}'" --account-name="'${ADMIN_USERNAME}'" --account-pass="'${ADMIN_PASSWORD}'" --account-mail="'${ADMIN_EMAIL}'" --site-name="'${SITE_NAME}'" --site-mail="'${ADMIN_EMAIL}'" ') || return 1
        echo ">>> Configuring trusted host"
        if [ "${USE_HTTPS}" == "on" ];
        then 
            PROTO="https://"
        else
            PROTO="http://"
        fi
        sed -i "/# \\$base_url.*/c\\\$base_url = '$PROTO$TRUSTED_HOST';" /var/www/drupal/web/sites/default/settings.php

        echo ">>> Disable web cron"
        run vendor/bin/drush -y vset cron_safe_threshold 0
    else
        echo ">>> Already Configured"
    fi

    return 0


}



fail(){
  echo "[ Failed ]"
  echo "1" > /tmp/drupal
  return 1

}

success(){
  echo "[ Success ]"
  echo "0" > /tmp/drupal
  return 0

}


install && config && success || fail

